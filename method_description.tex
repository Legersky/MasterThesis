\section{Addition}

The general idea of addition (standard or parallel) in any numeration system $(\beta,\A)$ is the following: we sum up two numbers digitwise and then we convert the result with digits in $\A+\A$ into the alphabet $\A$. Obviously, digitwise addition is computable in parallel, thus the problematic part is the digit set conversion of the obtained result. It can be easily done in a standard way but a parallel digit set conversion is non-trivial. A parallel conversion is based on the same  formulas as the standard one but the choice of so-called \emph{weight coefficients} differs.

Now, we go step by step more precisely. Let $x,y \in \fin{\A}$ with $(\beta,\A)$-representations $x_{n'}x_{{n'}-1}\cdots x_1 x_0\bullet x_{-1} x_{-2} \cdots x_{-m'}$ and $y_{n'}y_{{n'}-1}\cdots y_1 y_0\bullet y_{-1} y_{-2} \cdots y_{-m'}$ padded by zeros to have the same length $n'+m'+1$. We set 
  \begin{align*}
    w&=x+y =\sum_{i=-m'}^{n'} x_i\beta^i + \sum_{i=-m'}^{n'} y_i\beta^i = \sum_{i=-m'}^{n'} (x_i+y_i)\beta^i \\
    &=\sum_{i=-m'}^{n'} w_i\beta^i \,,
  \end{align*}
  where $w_i=x_i+y_i \in \A +\A$. Thus, $w_{n'} w_{{n'}-1}\cdots w_1 w_0 \bullet w_{-1} w_{-2} \cdots w_{-m'}$ is a  $(\beta, \A+\A)$-representation of $w\in \fin{\A+\A}$. 

We also use column notation for digitwise addition in what follows, e.g.,    
%	\begin{center}
%	\begin{tabulary}{0.7\textwidth}{CCCCCCCCCCCL}
%	$x_{n'}$& $x_{{n'}-1}$ & $\cdots$ & $x_1$ &$x_0$ &$\bullet$  &$x_{-1}$ & $x_{-2}$ & $\cdots$ & $x_{-m'}$ & $=$& $(x)_{\beta,\A}$\\
%	$y_{n'}$& $y_{{n'}-1}$ & $\cdots$ & $y_1$ &$y_0$ &$\bullet$  &$y_{-1}$ & $y_{-2}$ & $\cdots$ & $y_{-m'}$ & $=$& $(y)_{\beta,\A}$\\ \hline
%	$w_{n'}$& $w_{{n'}-1}$ & $\cdots$ & $w_1$ &$w_0$ &$\bullet$  &$w_{-1}$ & $w_{-2}$ & $\cdots$ & $w_{-m'}$ & $=$& $(x+y)_{\beta,\A+\A}$\\\,.
%	\end{tabulary}	
%	\end{center}
 
  \begin{align*}
  x_{n'} \;x_{{n'}-1}\cdots x_1 \;x_0 &\bullet x_{-1} \;x_{-2}\, \cdots x_{-m'} \\[-3pt]
  y_{n'} \;y_{{n'}-1}\cdots y_1 \,\;y_0 &\bullet y_{-1} \;y_{-2} \;\cdots y_{-m'} \\[-10pt]
    \line(1,0){90} & \line(1,0){100} \\[-7pt]
  w_{n'} w_{{n'}-1}\cdots w_1 w_0 &\bullet w_{-1} w_{-2} \cdots w_{-m'}\,.
  \end{align*}
  
We search for a $(\beta,\A)$-representation of $w$, i.e., a  sequence 
  $$z_{n} z_{n-1}\cdots z_1 z_0 z_{-1} z_{-2} \cdots z_{-m}$$ such that $z_j \in \A$ and
  $$
    z_{n} z_{n-1}\cdots z_1 z_0 \bullet z_{-1} z_{-2} \cdots z_{-m}=(w)_{\beta,\A}\,.
  $$
  Note that the index of the first, resp. last, non-zero digit of the converted representation $z_{n} z_{n-1}\cdots z_1 z_0 \bullet z_{-1} z_{-2} \cdots z_{-m}=(w)_{\beta,\A}$ may differ from the original representation $w_{n'} w_{{n'}-1}\cdots w_1 w_0 \bullet w_{-1} w_{-2} \cdots w_{-m'}$. We assume that $ n\geq n'$ and $m\geq m'$, otherwise we pad the converted representation by zeros.
  
   Multiplication of a representation $w_{n'} w_{n-1}\cdots w_1 w_0 \bullet w_{-1} w_{-2} \cdots w_{-m'}$ by a power of $\beta$ is obvious:
  $$
  \beta^m \cdot w_{n'} w_{n'-1}\cdots w_1 w_0 \bullet w_{-1} w_{-2} \cdots w_{-m'} = w_{n} w_{n'-1}\cdots w_1 w_0 w_{-1} w_{-2} \cdots w_{-m'} \bullet
  $$  
  and after conversion
  $$
  z_{n} z_{n-1}\cdots z_1 z_0 z_{-1} z_{-2} \cdots z_{-m'}\bullet\cdots z_{-m} = \beta^m \cdot z_{n} z_{n-1}\cdots z_1 z_0 \bullet z_{-1} z_{-2} \cdots z_{-m'}\,. 
  $$  
Hence, without lost of generality, we consider only conversion of so-called $\beta$-integers -- numbers from $\fin{\A+\A}$ whose representations have all digits with negative indices equal to zero.
%  Particularly, let $(w)_{\beta, \A+\A}=w_{n'} w_{{n'}-1}\cdots w_1 w_0 \bullet$. We search for a number $n \in \NN$ and \mbox{$z_{n}, z_{n-1},\dots, z_1, z_0 \in\A$} such that $(w)_{\beta, \A}=z_{n} z_{n-1}\cdots z_1 z_0 \bullet$.   
  
  Digits $w_j$ are converted into the alphabet $\A$ by adding a suitable representation of zero digitwise.
  For our purpose, we use the simplest possible representation which is deduced from the polynomial
  $$
    x-\beta \in \left(\Zomega\right)[x]\,.
  $$

We remark that any polynomial $R(x)=r_s x^s+r_{s-1}x^{s-1}+ \dots + r_1 x+r_0$ with coefficients $r_i \in \Zomega$ such that $R(\beta)=0$ gives us a possible representation of zero. The polynomial $R$ is called a \emph{rewriting rule}. One of the coefficients of $R$ which is greatest in modulus (so-called \emph{core coefficient}) is used for the conversion of a digit $w_j$. Nevertheless, the extending window method is strongly dependent on the rewriting rule, so we focus only on the simplest possible rewriting rule $R(x)=x-\beta$. Usage of an arbitrary rewriting rule $R$ is out of scope of this thesis.

 
As $0=\beta^{j} \cdot R(\beta)=1\cdot \beta^{j+1} -\beta \cdot \beta^{j}$, we have a representation of zero 
$$1 (-\!\beta) \underbrace{0 \cdots 0}_{j}\bullet = (0)_\beta\,. $$
for all $j \in \NN$. We multiply this representation by $q_j \in \Zomega$, which is called a \emph{weight coefficient}, to obtain another  representation of zero 
%$$q_j (-q_j\beta) \underbrace{0 \cdots 0}_{j}\bullet = (0)_\beta\,. $$ 
$q_j (-q_j\beta) 0 \cdots 0\bullet = (0)_\beta\,. $
This is digitwise added to $w_{n} w_{n-1}\cdots w_1 w_0 \bullet$ to convert the digit $w_j$ into the alphabet $\A$. The conversion of $j$-th digit causes a \emph{carry} $q_{j}$ on the $(j+1)$-th position. 

In standard addition, the digit set conversion runs from the right ($j=0$) to the left until all non-zero digits and carries are converted into the alphabet $\A$:

	\begin{tabular}{rcccccccclcl}
	$w_{n'}$ & $w_{{n'}-1}$ & $\cdots$ & $w_{j+1}$ &\textcolor{red}{$w_{j}$} &$w_{j-1}$ & $\cdots$ & $w_1$ &$w_0$ &$\bullet$ & $=$&$(w)_{\beta,{\A+\A}}$\\
	  &   & &   &  &$q_{j-2}$ & $\iddots$ &  &  &\\
	   &   & &   & \textcolor{red}{$q_{j-1}$}  & $-\beta q_{j-1}$ &  &  &  &\\
	  &   &  $\iddots$&  $q_{j}$ &  \textcolor{red}{$-\beta q_{j}$} & & &  &  &\\ \cline{1-10}
	$z_{n} \cdots z_{n'}$ & $z_{{n'}-1}$ & $\cdots$ & $z_{j+1}$ &\textcolor{red}{$z_{j}$} &$z_{j-1}$ & $\cdots$ & $z_1$ &$z_0$ &$\bullet$  & $=$&$(w)_{\beta,{\A}}$\\
	\end{tabular}

%        \begin{align}
%        \label{eq:conversionScheme}
%            \hspace{100pt}  w_n w_{n-1}&&&\cdots& &w_{j+1}&\!\! &\textcolor{red}{w_j}  & \!\!  &w_{j-1} &&\cdots &&w_1 w_0\bullet \hspace{100pt} \notag\\[-5pt]
%                         &&&&       &       & &     &   &q_{j-2} &&\iddots  \notag \\[-3pt] 
%                         &&&&       &       & &\textcolor{red}{q_{j-1}}& -&\beta q_{j-1} \notag \\[-3pt]
%                         &&&&         &q_j&   \textcolor{red}{-}&\textcolor{red}{\beta q_j} &&\\[-8pt]
%                         &&&  \iddots      &   -&\beta q_{j+1}&   &\ && \notag \\[-17pt]
%          \intertext{\hspace{60pt}\line(1,0){300}}
%          \notag \\[-30pt]
%           z_{n'} \cdots z_{n} z_{n-1}&&&\cdots& &z_{j+1}& &\textcolor{red}{z_j}& &z_{j-1} &&\cdots &&z_1 \; z_0\bullet \notag                  
%        \end{align}
    Hence, the desired formula for conversion on the $j$-th position is 
    \begin{equation*}
        z_j=w_j + q_{j-1} - q_j \beta
    \end{equation*}
    for $j \in \NN$. We set $q_{-1}=0$ as there is no carry from the right on the 0-th position.
    
     The terms carry and weight coefficient are related to a position: while $q_{j-1}$ is a carry from the right  and $q_j$ is a chosen weight coefficient on the $j$-th position, $q_j$ is a carry from the right on the $(j+1)$-th position etc.

We remark that the conversion with the rewriting rule $x-\beta$ prolongs the part of non-zero digits only to the left as there is no carry from the left. Thus, all digits with negative indices of the converted sequence are zero.


     The fact that the conversion preserves the value of $w$ follows from adding a representation of zero:
\begin{align}
\label{eq:valuePreserving}
    \sum_{j\geq 0} z_j \beta^j &=w_0 - \beta q_0 + \sum_{j> 0} (w_j + q_{j-1} - q_j \beta) \beta^j \notag\\
    &=\sum_{j\geq 0} w_j \beta^j + \sum_{j>0} q_{j-1} \beta^j - \sum_{j\geq 0} q_j \cdot \beta^{j+1}  \\
    &=\sum_{j\geq 0} w_j \beta^j + \sum_{j>0} q_{j-1} \beta^j - \sum_{j> 0} q_{j-1} \cdot \beta^j \notag\\
    &=\sum_{j\geq 0} w_j \beta^j = w\,. \notag
\end{align}

    The weight coefficient $q_j$ must be chosen so that the converted digit is in the alphabet~$\A$, i.e., 
    \begin{equation}
    \label{eq:conversionFormula}
        z_j=w_j + q_{j-1} - q_j \beta \in \A\,.
    \end{equation} 
    The choice of weight coefficients is a crucial part of the construction of addition algorithms which are computable in parallel. The extending window method determining weight coefficients for a given input is described in Section~\ref{sec:methodDescription}.
    
    
     On the other hand, the following example shows that determining weight coefficients is trivial for  numeration systems such that an alphabet contains right one representative of each class modulo $\beta$.
     
     \begin{exmp}
        Assume now a numeration system $(\beta, \A)$, where
  $$
    \beta \in \NN\,,\beta  \geq 2\,, \A = \{0, 1, 2,\dots, \beta -1 \}\,.
  $$ 
       Notice that
    $$
        z_j \equiv w_j+q_{j-1} \mod \beta\,. 
    $$
  
  There is only one representative of each class modulo  $\beta$ in the standard numeration system $(\beta, \A)$. Therefore, the digit $z_j$ is uniquely determined for a given digit $w_j \in \A+\A$ and carry $q_{j-1}$ and thus so is the weight coefficient $q_j$. This means that $q_j=q_j(w_j,q_{j-1})$ for all $j\geq 0$. Generally,
  $$
  q_j=q_j(w_j,q_{j-1}(w_{j-1},q_{j-2}))=\dots =q_j(w_j ,\dots , w_1, w_0)
  $$
  and
  $$
  z_j=z_j(w_j ,\dots , w_1, w_0)\,,
  $$
  which implies that addition runs in linear time. For instance, the carry $q_{j-1}=1$ propagates through the whole result when we sum up $(\beta-1)(\beta-1)\dots(\beta-1)\bullet$ and $1\bullet$.
     
     \end{exmp}
  
  We require that the digit set conversion from $\A+\A$ into $\A$ is computable in parallel, i.e., there exist constants $r,t \in \NN_0$ such that for all $j\geq 0$ is $z_j=z_j(w_{j+t},\dots,w_{j-r})$. Anticipation $t$ equals zero since we use the rewriting rule $x-\beta$. To avoid the dependency on all less significant digits, we need variety in the choice of the weight coefficient $q_j$. This implies that the used numeration system must be redundant.
  

\section{Extending window method}
\label{sec:methodDescription}
In order to construct a digit set conversion in numeration system $(\beta,\A)$ from $\A+\A$ to $\A$ which is computable in parallel, we consider a digit set conversion from an \emph{input alphabet} $\B$ such that $\A \subsetneq \B \subset \A+\A$ instead of the alphabet $\A+\A$.
As mentioned above, the key problem is to find for every $j\geq 0$ a weight coefficient $q_j$ such that 
    $$
        z_j=\underbrace{w_j}_{\in \B} + q_{j-1} - q_j \beta \in \A 
    $$  
    for any input $w_{n'}w_{n'-1}\dots w_1 w_0 \bullet=(w)_{\beta,\B}, w\in \fin{\B}$. We remark that the weight coefficient $q_{j-1}$ is determined by the input $w_{j-1}\dots w_1 w_0 \bullet$. For a digit set conversion with the rewriting rule $x-\beta$ to be computable in parallel, the digit $z_j$ is required to satisfy $z_j=z_j(w_{j},\dots,w_{j-r})$ for a fixed memory $r$ in $\NN$.
    
    Note that the digit $z_j$ is given by the input digit $w_j$ and carry $q_{j-1}$ which is determined by input digits  $w_{j-1} w_{j-2}\dots$. Thus, if we find a weight coefficient $q_j$ for all possible combinations of input digits $w_j w_{j-1} w_{j-2}\dots$, then the position $j$ is not important. Therefore, we may strongly simplify our notation if we omit $j$ in subscripts. From now on, $w_0\in\B$ is a converted digit, $w_{-1} w_{-2}\dots\in\B$ are digits on right, $q_{-1}\in\Zomega$ is a carry from the right and we search for a weight coefficient $q_0\in\Zomega$ such that 
    $$
    z_0=w_0 + q_{-1} - q_0 \beta \in \A\,.
    $$
    
   
    We introduce two definitions before we describe the extending window method.
    \begin{defn}
    \label{def:weightCoefficientsSet}
        Let $\B$ be a set such that $\A \subsetneq \B \subset \A+\A$. Then any finite set $\Q\subset\Zomega$ containing~0 such that 
        $$
            \B + \Q \subset \A + \beta \Q
        $$  
        is called a \emph{weight coefficients set}.
    \end{defn}
    We see that if $\Q$ is a weight coefficients set, then
        $$
        (\forall w_0 \in \B)(\forall q_{-1}\in\Q)(\exists q_0 \in \Q )(\underbrace{w_0 + q_{-1} - q_0 \beta}_{z_0} \in \A )\,.
        $$
    In other words, there is a weight coefficient $q_0 \in \Q$ for a carry from the right $q_{-1}\in \Q$ and a digit $w_0$ in the input alphabet $\B$ such that $z_0$ is in the alphabet $\A$.  Notice that  the  carry from the right for the rightmost non-zero digit of the converted sequence which is $0$ is in $\Q$ by the definition.
    \begin{defn}
    Let $r$ be an integer and $q:\B^{r} \rightarrow \Q$ be a mapping such that 
    $$
    w_0+ q(w_{-1}, \dots, w_{-r}) - \beta q\tupleo{(r-1)} \in \A
    $$
    for all $w_0,w_{-1}, \dots, w_{-r} \in \B$, and $q(0,0,\dots,0)=0$. Then $q$ is called \emph{weight function} and $r$~is called \emph{length of window}.    
    \end{defn}

 Having a weight function $q$, we define a function $\phi:\B^{r+1}\rightarrow \A$ by
    \begin{equation}
    \label{eq:localConversion}
        \phi(w_{0}, \dots, w_{-r})=w_0+ \underbrace{q(w_{-1}, \dots, w_{-r})}_{=q_{-1}} - \beta \underbrace{q\tupleo{(r-1)}}_{=q_0}=:z_0\,,
    \end{equation} 
    which verifies that the digit set conversion is indeed a $(r+1)$-local function with anticipation $0$ and memory $r$. The requirement of zero output of the weight function $q$ for the input of $r$ zeros guarantees that $\phi(0,0,\dots,0)=0$. Thus, the first condition of Definition~\ref{def:digitSetConversion} is satisfied. The second one follows from the equation \eqref{eq:valuePreserving}. 
    
Let us summarize the construction of the digit set conversion by the rewriting rule \mbox{$x-\beta$}. We need to find weight coefficients for all possible combinations of digits of the input alphabet~$\B$. The rewriting rules multiplied by the weight coefficients are digitwise added to an input sequence. In fact, it means that the equation  \eqref{eq:conversionFormula} is applied on each position. If the digit set conversion is computable in parallel, the weight coefficients are determined as the outputs of the weight function $q$ with some fixed length of window $r$.  

We search for a weight function $q$ for a given base $\beta$ and input alphabet $\B$ by the extending window method. It consists of two phases. First, we find some weight coefficients set $\Q$. We know that it is possible to convert an input sequence by choosing the weight coefficients from the set $\Q$. The set $\Q$ serves as the starting point for the second phase in which we increment the expected length of the window $r$ until the weight function $q$ is uniquely defined for each $\tupleo{(r-1)} \in \B^{r}$. Then, the local conversion is determined -- we use the weight function outputs as weight coefficients in the formula \eqref{eq:localConversion}.    

We describe the general concept of the extending window method in this chapter, while various possibilities of construction of sets during both phases are discussed in Chapter~\ref{chap:diffChoices}.
Note that  convergence of both phases is studied in Chapter~\ref{chap:convergence}.
      
\section{Phase 1 -- Weight coefficients set}
\label{subsec:phase1}
The goal of the first phase is to compute a weight coefficients set $\Q$, i.e., to find a set $\Q \ni 0$ such that 
$$
    \B + \Q \subset \A + \beta \Q\,.
$$  
We build a sequence $\Q_0, \Q_1, \Q_2,\dots$ iteratively so that we extend $\Q_k$ to $\Q_{k+1}$ in a way to cover all elements of the set $\B+\Q_k$ by elements of the extended set $\Q_{k+1}$, i.e.,
$$
\B+ \Q_k \subset \A + \beta \Q_{k+1}\,.
$$
This procedure is repeated until the extended weight coefficients set $\Q_{k+1}$ is the same as the previous set $\Q_{k}$. We remark that the expression ``a weight coefficient $q$ covers an element $x$'' means that there is a digit $a \in \A$ such that $x=a + \beta q$. 

In other words, we start with $\Q_0=\{0\}$ meaning that we search all weight coefficients $q_0$ necessary for digit set conversion for the case where there is no carry from the right, i.e., $q_{-1}=0$. We add them to the weight coefficients set $\Q_0$ to obtain the set $\Q_1$. Assume now that we have a set $\Q_k$ for some $k\geq 1$. The weight coefficients in $\Q_k$ now may appear as a carry $q_{-1}$. If there are no suitable weight coefficients $q_0$ in the weight coefficients set~$\Q_k$ to cover all sums of coefficients from $\Q_k$ and digits of the input alphabet $\B$, we extend $\Q_k$ to $\Q_{k+1}$ by  suitable coefficients. And so on until there is no need to add more elements, i.e., the extended set $\Q_{k+1}$ equals $\Q_k$. Then the weight coefficients set $\Q:=\Q_{k+1}$ satisfies Definition~\ref{def:weightCoefficientsSet}. 

For better understanding, see Figures~\ref{img:phase1img3}--\ref{img:phase1img12} in Appendix~\ref{app:phase1} which illustrate the construction of the weight coefficients set $\Q$ for the Eisenstein base and a complex alphabet. 

The precise description of the algorithm in a pseudocode is in Algorithm~\ref{alg:weightCoefSet}. Observe that extending $\Q_k$ to $\Q_{k+1}$ is not unique. Various methods of choice are described in Section~\ref{sec:methodsOne} in Algorithm~\ref{alg:extendWeightCoefSet}.
    



Section~\ref{sec:convergencePhase2} discusses the convergence of Phase 1, i.e. whether it happens that  $\Q_{k+1}=\Q_k$ for some  $k$.
    
\begin{algorithm}
  \caption{Search for weight coefficients set (Phase 1)}
    \label{alg:weightCoefSet}
  \begin{algorithmic}[1]
    \STATE $k:=0$ 
    \STATE $Q_0:=\{0\}$
    \REPEAT
     \STATE Extend $\Q_k$ to $\Q_{k+1}$ (by Algorithm~\ref{alg:extendWeightCoefSet}) so that $$\B+ \Q_k \subset \A + \beta \Q_{k+1}$$
     \vspace{-20pt}
      \STATE  $k:=k+1$
      \UNTIL{$\Q_k = \Q_{k+1}$}      
      \STATE $\Q:=\Q_k$
    \RETURN $\Q$
  \end{algorithmic}
\end{algorithm}


    

  
    
    





\section{Phase 2 -- Weight function}
\label{subsec:phase2}
    We want to find a length of the window $r$ and a weight function $q:\B^{r} \to \Q$. We start with the weight coefficients set $\Q$ obtained in Phase 1. The idea is to reduce necessary weight coefficients which are used to convert a given input digit up to a single value. This is done by enlarging the number of considered input digits, i.e. incrementing $r$.  If the window is extended to the right, we know more digits that cause a carry form the right. This may decrease the number of  possible carries from the right and hence, less weight coefficients to convert the input digit may be necessary.
     
    We introduce notation for sets of possible weight coefficients for given input digits.
        Let $\Q$ be a weight coefficients set and $w_0\in \B$. Denote by $\Q_{[w_0]}$ any set such that
        $$
            (\forall q_{-1} \in \Q)(\exists q_0 \in \Q_{[w_0]})(w_0 + q_{-1} - q_0 \beta \in \A)\,.
        $$
It means that we do not know any input digits on the right, therefore there might be any carry from the set $\Q$. However, we may determine a set $\Q_{[w_0]}$ of  weight coefficients which allow the conversion of $w_0$ to $\A$ since we know the input digit $w_0$.
        
        By induction with respect to $k \in \NN, k\geq 1$, for all $\tupleo{k}\in \B^{k+1}$ denote by $\Qwo{k}$ any subset of  $\Qwo{(k-1)}$ such that 
        $$
           (\forall q_{-1} \in \Qw{1}{k})(\exists q_0 \in \Qwo{k})(w_0 + q_{-1} - q_0 \beta \in \A)\,.
        $$
        
    
 
%    Recall the scheme \eqref{eq:conversionScheme} of the digit set conversion for better understanding of the notation and method:
%    \begin{align*}
%        \hspace{130pt}\cdots\; &w_{j+1}&\!\! &w_j  & \!\!  &w_{j-1}&\cdots w_{j-M+1} &w_{j-M}\cdots \hspace{130pt} \\[-3pt] 
%                         & &       & & & q_{j-2} \\[-3pt]
%                         & &       &q_{j-1}& -&\beta q_{j-1} \\[-3pt]
%                           &q_j&   -&\beta q_j &&\\[-3pt]      
%                           -&\beta q_{j+1}&   &  &&\\[-15pt]      
%    \intertext{\hspace{120pt}\line(1,0){250}} 
%          \vspace{-15pt}
%          \\[-30pt]
%     \cdots\; &z_{j+1}& &z_j& &z_{j-1}& \cdots z_{j-M+1}\; &z_{j-M}\cdots                     
%    \end{align*}     

Sets of possible weight coefficients and a weight function $q$ are constructed by Algorithm~\ref{alg:weightFunction}. The idea is to check all possible right carries $q_{-1}\in\Q$ and determine values $q_0\in\Q$ such that 
    $$
    z_0=w_0 + q_{-1} - q_0 \beta \in \A \,.
    $$  
    
    So we obtain a set $\Q_{[w_0]}\subset\Q$ of weight coefficients which are necessary to convert the digit~$w_0$ with any carry $q_{-1}\in\Q$. Assuming that we know the input digit $w_{-1}$, the set of possible carries from the right is also reduced to $\Q_{[w_{-1}]}$. Thus we may reduce the set $\Q_{[w_0]}$ to a set $\Qwo{1}\subset \Q_{[w_0]}$ which is necessary to cover all elements of $w_0 + \Q_{[w_{-1}]}$. 

In the $k$-th step, we search for a set $\Qwo{k}\subset\Qwo{(k-1)}$ such that 
               $$
              w_0 + \Qw{1}{k} \subset \A + \beta \Qwo{k}\,.
              $$
              The length of window is $k+1$, i.e., we know $k$ digits on the right. To  construct the set $\Qwo{k}$, we select from $\Qwo{(k-1)}$ such weight coefficients which are necessary to convert digit $w_0$ to the alphabet $\A$ with all possible carries from the set $\Qw{1}{k}$.
                 
    Proceeding in this manner may lead to a unique weight coefficient $q_0$ for enough long window.     
    If there is $r\in\NN, r\geq 1$ such that 
    $$
    \#\Qwo{(r-1)}=1
    $$
    for all $\tupleo{(r-1)} \in \B^r$, then the output $q\tupleo{(r-1)}$ is defined as the element of $\Qwo{(r-1)}$. 
    
    Similarly to Phase 1, the choice of $\Qwo{k}$ is not unique. We list different methods of choice in Section~\ref{sec:methodsTwo}, Algorithm~\ref{alg:minimalSet}.
    
    Figures~\ref{img:phase2img3}--\ref{img:phase2img7} in Appendix~\ref{app:phase2} illustrate the construction of the set $\Q_{[\omega,1,2]}$ for the Eisenstein numeration system.
    
        
    To verify that 
$$
	z_0=\phi(w_{0}, \dots, w_{-r})=w_0+ \underbrace{q\tuple{1}{r}}_{=q_{-1}} - \beta \underbrace{q\tupleo{(r-1)}}_{=q_0}
$$    
is in the alphabet $\A$, consider that $q_0=q\tupleo{(r-1)}$ is the only element of $\Qwo{(r-1)}$ which was constructed such that 
$$
w_0 + \Qw{1}{(r-1)} \subset \A +\beta \Qwo{(r-1)}\,.
$$
At the same time, $q_{-1}=q\tupleo{(r-1)}$ is the only element of $\Qw{1}{r}$ which is a subset of $\Qw{1}{(r-1)}$.

    

    
\begin{algorithm}
  \caption{Search for weight function $q$ (Phase 2)}
    \label{alg:weightFunction}
  \begin{algorithmic}[1]
    \REQUIRE{weight coefficients set $\Q$}
    \FORALL{$w_0 \in \B$} 
        \STATE Find set $\Q_{[w_0]} \subset \Q$ (by Algorithm~\ref{alg:minimalSet}) such that
          $$
          w_0 + \Q \subset \A + \beta \Q_{[w_0]}
          $$
    \ENDFOR
    \STATE $k:=0$
    \WHILE{$\max\{\#\Qwo{k}\colon \tupleo{k}\in \B^{k+1} \} > 1$}
        \STATE $k:= k +1$
        \FORALL{$\tupleo{k}\in \B^{k+1}$}
            \STATE Find set $\Qwo{k} \subset \Qwo{(k-1)}$ (by Algorithm~\ref{alg:minimalSet}) such that
              $$
              w_0 + \Qw{1}{k} \subset \A + \beta \Qwo{k}\,,
              $$
        \ENDFOR  
    \ENDWHILE  
    \STATE $r:= k+1$ 
    \FORALL{$\tupleo{(r-1)} \in \B^{r}$}  
        \STATE $q\tupleo{(r-1)}\in \B^{r}:=$ only element of $\Qwo{(r-1)}$
    \ENDFOR
    \RETURN $q$
  \end{algorithmic}
\end{algorithm}

Unfortunately, finiteness of Phase 2 is not guaranteed. But the non-convergence of Phase 2 with a specific property may be revealed by Algorithm~\ref{alg:oneletterSets} before the run of Phase 2 or by Algorithm~\ref{alg:checkCycles} during it. These algorithms are based on theorems in Chapter ~\ref{chap:convergence}. Modified Phase 2 which includes these algorithms can be found in Section~\ref{sec:modifiedPhase2}.



Notice that for a given length of window $r$, the number of calls of Algorithm~\ref{alg:minimalSet} within Algorithm~\ref{alg:weightFunction} is
$$
\sum_{k=0}^{r-1}  \#\B^{k+1} = \#\B \frac{\#\B^r-1}{\#\B-1}\,.
$$    
It implies that the time complexity grows exponentially. The required memory is also exponential because we have to store sets $\Qwo{k}$ at least for $k\in\{r-2, r-1\}$  for all $w_0,\dots, w_{-k} \in \B$.
